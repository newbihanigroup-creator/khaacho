generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextIndex", "fullTextSearch"]
  binaryTargets   = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String             @id @default(uuid())
  phoneNumber        String             @unique @map("phone_number")
  email              String?            @unique
  name               String
  role               UserRole
  businessName       String?            @map("business_name")
  address            String?
  city               String?
  state              String?
  pincode            String?
  isActive           Boolean            @default(true) @map("is_active")
  isVerified         Boolean            @default(false) @map("is_verified")
  passwordHash       String             @map("password_hash")
  lastLoginAt        DateTime?          @map("last_login_at")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  createdBy          String?            @map("created_by")
  deletedAt          DateTime?          @map("deleted_at")
  auditLogs          AuditLog[]
  createdInvoices    Invoice[]          @relation("InvoiceCreatedBy")
  orderStatusChanges OrderStatusLog[]   @relation("OrderStatusChanges")
  createdOrders      Order[]            @relation("OrderCreatedBy")
  retailerProfile    Retailer?
  createdSettlements VendorSettlement[] @relation("SettlementCreatedBy")
  vendorProfile      Vendor?

  @@index([phoneNumber])
  @@index([email])
  @@index([role, isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("users")
}

model VendorRanking {
  id              String   @id @default(uuid())
  vendorId        String   @unique @map("vendor_id")
  vendorScore     Decimal  @map("vendor_score") @db.Decimal(8, 2)
  priceIndex      Decimal  @map("price_index") @db.Decimal(5, 2)
  acceptanceRate  Decimal  @map("acceptance_rate") @db.Decimal(5, 2)
  completionRate  Decimal  @map("completion_rate") @db.Decimal(5, 2)
  avgDeliveryTime Decimal  @map("avg_delivery_time") @db.Decimal(8, 2)
  totalOrders     Int      @default(0) @map("total_orders")
  acceptedOrders  Int      @default(0) @map("accepted_orders")
  completedOrders Int      @default(0) @map("completed_orders")
  cancelledOrders Int      @default(0) @map("cancelled_orders")
  rank            Int      @default(0)
  lastUpdated     DateTime @default(now()) @map("last_updated")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  vendor          Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorScore])
  @@index([rank])
  @@index([lastUpdated])
  @@map("vendor_rankings")
}

model Vendor {
  id                String              @id @default(uuid())
  userId            String              @unique @map("user_id")
  vendorCode        String              @unique @map("vendor_code")
  businessLicense   String?             @map("business_license")
  taxId             String?             @unique @map("tax_id")
  gstNumber         String?             @map("gst_number")
  panNumber         String?             @map("pan_number")
  bankAccountNumber String?             @map("bank_account_number")
  bankIfscCode      String?             @map("bank_ifsc_code")
  bankName          String?             @map("bank_name")
  creditLimit       Decimal             @default(0) @map("credit_limit") @db.Decimal(15, 2)
  commissionRate    Decimal             @default(0) @map("commission_rate") @db.Decimal(5, 2)
  rating            Decimal             @default(0) @db.Decimal(3, 2)
  totalSales        Decimal             @default(0) @map("total_sales") @db.Decimal(15, 2)
  isApproved        Boolean             @default(false) @map("is_approved")
  approvedAt        DateTime?           @map("approved_at")
  approvedBy        String?             @map("approved_by")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  deletedAt         DateTime?           @map("deleted_at")
  creditLedgers     CreditLedger[]
  broadcastLogs     OrderBroadcastLog[]
  orders            Order[]
  payments          Payment[]
  vendorInventories VendorInventory[]   @relation("VendorInventory")
  vendorProducts    VendorProduct[]
  rankings          VendorRanking?
  settlements       VendorSettlement[]
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([vendorCode])
  @@index([taxId])
  @@index([isApproved, deletedAt])
  @@index([createdAt])
  @@map("vendors")
}

model RetailerRiskProfile {
  id                  String    @id @default(uuid())
  retailerId          String    @unique @map("retailer_id")
  businessName        String    @map("business_name")
  ownerName           String    @map("owner_name")
  location            String?
  businessType        String    @map("business_type")
  kycStatus           String    @map("kyc_status")
  bankAccountVerified Boolean   @default(false) @map("bank_account_verified")
  creditLimit         Decimal   @map("credit_limit") @db.Decimal(15, 2)
  currentOutstanding  Decimal   @map("current_outstanding") @db.Decimal(15, 2)
  availableCredit     Decimal   @map("available_credit") @db.Decimal(15, 2)
  riskScore           Int       @default(50) @map("risk_score")
  riskLevel           RiskLevel @default(MEDIUM)
  lastPaymentDate     DateTime? @map("last_payment_date")
  averagePaymentDays  Decimal   @map("average_payment_days") @db.Decimal(8, 2)
  overdueDays         Int?      @map("overdue_days")
  totalOrders         Int       @default(0) @map("total_orders")
  defaultFlag         Boolean   @default(false) @map("default_flag")
  fraudFlag           Boolean   @default(false) @map("fraud_flag")
  adminReviewRequired Boolean   @default(false) @map("admin_review_required")
  lastScoreUpdate     DateTime  @default(now()) @map("last_score_update")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  retailer            Retailer  @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@index([riskScore])
  @@index([riskLevel])
  @@index([overdueDays])
  @@index([lastPaymentDate])
  @@index([defaultFlag, fraudFlag])
  @@index([adminReviewRequired])
  @@map("retailer_risk_profiles")
}

model Retailer {
  id              String               @id @default(uuid())
  userId          String               @unique @map("user_id")
  retailerCode    String               @unique @map("retailer_code")
  shopName        String               @map("shop_name")
  gstNumber       String?              @map("gst_number")
  panNumber       String?              @map("pan_number")
  creditScore     Int                  @default(500) @map("credit_score")
  creditLimit     Decimal              @default(0) @map("credit_limit") @db.Decimal(15, 2)
  availableCredit Decimal              @default(0) @map("available_credit") @db.Decimal(15, 2)
  totalOrders     Int                  @default(0) @map("total_orders")
  totalSpent      Decimal              @default(0) @map("total_spent") @db.Decimal(15, 2)
  outstandingDebt Decimal              @default(0) @map("outstanding_debt") @db.Decimal(15, 2)
  lastOrderAt     DateTime?            @map("last_order_at")
  lastPaymentAt   DateTime?            @map("last_payment_at")
  isApproved      Boolean              @default(false) @map("is_approved")
  approvedAt      DateTime?            @map("approved_at")
  approvedBy      String?              @map("approved_by")
  riskCategory    String               @default("MEDIUM") @map("risk_category")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  deletedAt       DateTime?            @map("deleted_at")
  creditLedgers   CreditLedger[]
  invoices        Invoice[]
  orders          Order[]
  payments        Payment[]
  rejectedOrders  RejectedOrder[]      @relation("RejectedOrders")
  riskProfile     RetailerRiskProfile?
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  uploadedOrders  UploadedOrder[]

  @@index([retailerCode])
  @@index([creditScore])
  @@index([isApproved, deletedAt])
  @@index([lastOrderAt])
  @@index([outstandingDebt])
  @@index([createdAt])
  @@map("retailers")
}

model Product {
  id                String            @id @default(uuid())
  productCode       String            @unique @map("product_code")
  name              String
  description       String?
  category          String?
  subCategory       String?           @map("sub_category")
  brand             String?
  unit              String
  hsnCode           String?           @map("hsn_code")
  barcode           String?           @unique
  minOrderQty       Int               @default(1) @map("min_order_qty")
  maxOrderQty       Int?              @map("max_order_qty")
  isActive          Boolean           @default(true) @map("is_active")
  isFeatured        Boolean           @default(false) @map("is_featured")
  imageUrl          String?           @map("image_url")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  deletedAt         DateTime?         @map("deleted_at")
  orderItems        OrderItem[]
  orders            Order[]
  vendorInventories VendorInventory[] @relation("ProductInventory")
  vendorProducts    VendorProduct[]

  @@index([productCode])
  @@index([category, subCategory])
  @@index([isActive, deletedAt])
  @@index([name])
  @@map("products")
}

model VendorInventory {
  id                String          @id @default(uuid())
  vendorId          String?         @map("vendor_id")
  productId         String?         @map("product_id")
  price             Decimal         @db.Decimal(12, 2)
  availableQuantity Int             @map("available_quantity")
  minStock          Int             @default(0) @map("min_stock")
  maxStock          Int?            @map("max_stock")
  lastUpdated       DateTime        @default(now()) @map("last_updated")
  status            InventoryStatus @default(AVAILABLE)
  isActive          Boolean         @default(true) @map("is_active")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  product           Product?        @relation("ProductInventory", fields: [productId], references: [id], onDelete: Cascade)
  vendor            Vendor?         @relation("VendorInventory", fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, productId])
  @@index([vendorId, status])
  @@index([productId, status])
  @@index([availableQuantity])
  @@index([lastUpdated])
  @@map("vendor_inventories")
}

model VendorProduct {
  id              String    @id @default(uuid())
  vendorId        String    @map("vendor_id")
  productId       String    @map("product_id")
  sku             String    @unique
  vendorPrice     Decimal   @map("vendor_price") @db.Decimal(12, 2)
  mrp             Decimal   @db.Decimal(12, 2)
  discount        Decimal   @default(0) @db.Decimal(5, 2)
  stock           Int       @default(0)
  minStock        Int       @default(0) @map("min_stock")
  maxStock        Int?      @map("max_stock")
  leadTimeDays    Int       @default(0) @map("lead_time_days")
  isAvailable     Boolean   @default(true) @map("is_available")
  lastRestockedAt DateTime? @map("last_restocked_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  vendor          Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, productId])
  @@index([vendorId, isAvailable])
  @@index([productId])
  @@index([sku])
  @@index([stock])
  @@map("vendor_products")
}

model Order {
  id                 String              @id @default(uuid())
  orderNumber        String              @unique @map("order_number")
  retailerId         String              @map("retailer_id")
  vendorId           String?             @map("vendor_id")
  productId          String?             @map("product_id")
  vendorPrice        Decimal             @map("vendor_price") @db.Decimal(12, 2)
  status             OrderStatus         @default(PLACED)
  paymentStatus      PaymentStatus       @default(PENDING) @map("payment_status")
  subtotal           Decimal             @db.Decimal(15, 2)
  discount           Decimal             @default(0) @db.Decimal(15, 2)
  taxAmount          Decimal             @default(0) @map("tax_amount") @db.Decimal(15, 2)
  shippingCharges    Decimal             @default(0) @map("shipping_charges") @db.Decimal(15, 2)
  total              Decimal             @db.Decimal(15, 2)
  paidAmount         Decimal             @default(0) @map("paid_amount") @db.Decimal(15, 2)
  dueAmount          Decimal             @map("due_amount") @db.Decimal(15, 2)
  creditUsed         Decimal             @default(0) @map("credit_used") @db.Decimal(15, 2)
  notes              String?
  internalNotes      String?             @map("internal_notes")
  cancellationReason String?             @map("cancellation_reason")
  whatsappMessageId  String?             @map("whatsapp_message_id")
  invoiceNumber      String?             @unique @map("invoice_number")
  invoiceUrl         String?             @map("invoice_url")
  expectedDelivery   DateTime?           @map("expected_delivery")
  confirmedAt        DateTime?           @map("confirmed_at")
  shippedAt          DateTime?           @map("shipped_at")
  deliveredAt        DateTime?           @map("delivered_at")
  cancelledAt        DateTime?           @map("cancelled_at")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  createdBy          String?             @map("created_by")
  creditLedgers      CreditLedger[]
  invoices           Invoice[]
  broadcastLogs      OrderBroadcastLog[]
  items              OrderItem[]
  statusLogs         OrderStatusLog[]
  createdByUser      User?               @relation("OrderCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  product            Product?            @relation(fields: [productId], references: [id], onDelete: Cascade)
  retailer           Retailer            @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  vendor             Vendor?             @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  payments           Payment[]
  uploadedOrders     UploadedOrder[]
  vendorSettlements  VendorSettlement[]

  @@index([retailerId, createdAt(sort: Desc)])
  @@index([vendorId, createdAt(sort: Desc)])
  @@index([orderNumber])
  @@index([status, paymentStatus])
  @@index([createdAt(sort: Desc)])
  @@index([deliveredAt])
  @@index([invoiceNumber])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String   @map("order_id")
  productId   String   @map("product_id")
  productName String
  productSku  String
  quantity    Int
  unitPrice   Decimal  @map("unit_price") @db.Decimal(12, 2)
  discount    Decimal  @default(0) @db.Decimal(12, 2)
  taxRate     Decimal  @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount   Decimal  @default(0) @map("tax_amount") @db.Decimal(12, 2)
  subtotal    Decimal  @db.Decimal(15, 2)
  total       Decimal  @db.Decimal(15, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  order       Order    @relation(fields: [orderId], references: [id])
  product     Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([createdAt])
  @@map("order_items")
}

model CreditLedger {
  id               String          @id @default(uuid())
  ledgerNumber     String          @unique @map("ledger_number")
  retailerId       String          @map("retailer_id")
  vendorId         String          @map("vendor_id")
  orderId          String?         @map("order_id")
  paymentId        String?         @map("payment_id")
  transactionType  TransactionType @map("transaction_type")
  amount           Decimal         @db.Decimal(15, 2)
  runningBalance   Decimal         @map("running_balance") @db.Decimal(15, 2)
  previousBalance  Decimal         @map("previous_balance") @db.Decimal(15, 2)
  description      String
  referenceNumber  String?         @map("reference_number")
  dueDate          DateTime?       @map("due_date")
  isReversed       Boolean         @default(false) @map("is_reversed")
  reversedBy       String?         @map("reversed_by")
  reversalLedgerId String?         @map("reversal_ledger_id")
  metadata         Json?
  createdAt        DateTime        @default(now()) @map("created_at")
  createdBy        String?         @map("created_by")
  order            Order?          @relation(fields: [orderId], references: [id], onDelete: Restrict)
  payment          Payment?        @relation(fields: [paymentId], references: [id], onDelete: Restrict)
  retailer         Retailer        @relation(fields: [retailerId], references: [id])
  vendor           Vendor          @relation(fields: [vendorId], references: [id])

  @@index([retailerId, createdAt(sort: Desc)])
  @@index([vendorId, createdAt(sort: Desc)])
  @@index([orderId])
  @@index([paymentId])
  @@index([ledgerNumber])
  @@index([transactionType])
  @@index([createdAt(sort: Desc)])
  @@index([isReversed])
  @@index([dueDate])
  @@map("credit_ledgers")
}

model Payment {
  id             String         @id @default(uuid())
  paymentNumber  String         @unique @map("payment_number")
  retailerId     String         @map("retailer_id")
  vendorId       String         @map("vendor_id")
  orderId        String?        @map("order_id")
  amount         Decimal        @db.Decimal(15, 2)
  paymentMethod  PaymentMethod  @map("payment_method")
  paymentStatus  String         @default("PENDING") @map("payment_status")
  transactionId  String?        @unique @map("transaction_id")
  bankReference  String?        @map("bank_reference")
  chequeNumber   String?        @map("cheque_number")
  chequeDate     DateTime?      @map("cheque_date")
  bankName       String?        @map("bank_name")
  notes          String?
  receiptUrl     String?        @map("receipt_url")
  processedAt    DateTime?      @map("processed_at")
  failedAt       DateTime?      @map("failed_at")
  failureReason  String?        @map("failure_reason")
  isReversed     Boolean        @default(false) @map("is_reversed")
  reversedAt     DateTime?      @map("reversed_at")
  reversedBy     String?        @map("reversed_by")
  reversalReason String?        @map("reversal_reason")
  metadata       Json?
  createdAt      DateTime       @default(now()) @map("created_at")
  createdBy      String?        @map("created_by")
  creditLedgers  CreditLedger[]
  order          Order?         @relation(fields: [orderId], references: [id], onDelete: Restrict)
  retailer       Retailer       @relation(fields: [retailerId], references: [id])
  vendor         Vendor         @relation(fields: [vendorId], references: [id])

  @@index([retailerId, createdAt(sort: Desc)])
  @@index([vendorId, createdAt(sort: Desc)])
  @@index([orderId])
  @@index([paymentNumber])
  @@index([transactionId])
  @@index([paymentStatus])
  @@index([createdAt(sort: Desc)])
  @@index([isReversed])
  @@map("payments")
}

model AuditLog {
  id          String      @id @default(uuid())
  userId      String?     @map("user_id")
  action      AuditAction
  entityType  String      @map("entity_type")
  entityId    String?     @map("entity_id")
  oldValues   Json?       @map("old_values")
  newValues   Json?       @map("new_values")
  description String?
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")
  sessionId   String?     @map("session_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  user        User?       @relation(fields: [userId], references: [id])

  @@index([userId, createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

model WhatsAppMessage {
  id             String    @id @default(uuid())
  messageId      String    @unique @map("message_id")
  conversationId String?   @map("conversation_id")
  from           String
  to             String
  body           String?
  mediaUrl       String?   @map("media_url")
  type           String
  status         String
  direction      String
  orderId        String?   @map("order_id")
  retailerId     String?   @map("retailer_id")
  vendorId       String?   @map("vendor_id")
  isProcessed    Boolean   @default(false) @map("is_processed")
  processedAt    DateTime? @map("processed_at")
  errorMessage   String?   @map("error_message")
  metadata       Json?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([from, createdAt(sort: Desc)])
  @@index([to, createdAt(sort: Desc)])
  @@index([messageId])
  @@index([conversationId])
  @@index([orderId])
  @@index([status])
  @@index([isProcessed])
  @@index([createdAt(sort: Desc)])
  @@map("whatsapp_messages")
}

model OrderStatusLog {
  id            String   @id @default(uuid())
  orderId       String   @map("order_id")
  fromStatus    String?  @map("from_status")
  toStatus      String   @map("to_status")
  changedBy     String?  @map("changed_by")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")
  changedByUser User?    @relation("OrderStatusChanges", fields: [changedBy], references: [id])
  order         Order    @relation(fields: [orderId], references: [id])

  @@index([orderId, createdAt])
  @@index([toStatus])
  @@index([changedBy])
  @@map("order_status_logs")
}

model RetailerFinancialMetrics {
  id                          String   @id @default(uuid())
  retailerId                  String   @unique @map("retailer_id")
  totalOrdersLast30Days       Int      @default(0) @map("total_orders_last_30_days")
  totalOrdersLifetime         Int      @default(0) @map("total_orders_lifetime")
  totalPurchaseValue          Decimal  @default(0) @map("total_purchase_value") @db.Decimal(15, 2)
  averageOrderValue           Decimal  @default(0) @map("average_order_value") @db.Decimal(15, 2)
  paymentDelayAverageDays     Decimal  @default(0) @map("payment_delay_average_days") @db.Decimal(8, 2)
  onTimePaymentRatio          Decimal  @default(0) @map("on_time_payment_ratio") @db.Decimal(5, 2)
  totalPaymentsMade           Int      @default(0) @map("total_payments_made")
  onTimePayments              Int      @default(0) @map("on_time_payments")
  latePayments                Int      @default(0) @map("late_payments")
  outstandingCredit           Decimal  @default(0) @map("outstanding_credit") @db.Decimal(15, 2)
  creditLimit                 Decimal  @default(0) @map("credit_limit") @db.Decimal(15, 2)
  creditUtilizationPercentage Decimal  @default(0) @map("credit_utilization_percentage") @db.Decimal(5, 2)
  availableCredit             Decimal  @default(0) @map("available_credit") @db.Decimal(15, 2)
  orderFrequencyPerWeek       Decimal  @default(0) @map("order_frequency_per_week") @db.Decimal(8, 2)
  daysSinceFirstOrder         Int      @default(0) @map("days_since_first_order")
  daysSinceLastOrder          Int?     @map("days_since_last_order")
  lastCalculatedAt            DateTime @default(now()) @map("last_calculated_at")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  @@map("retailer_financial_metrics")
}

model CreditScoreHistory {
  id                     String   @id @default(uuid())
  retailerId             String   @map("retailer_id")
  score                  Int
  paymentTimelinessScore Int      @map("payment_timeliness_score")
  orderConsistencyScore  Int      @map("order_consistency_score")
  creditUtilizationScore Int      @map("credit_utilization_score")
  accountAgeScore        Int      @map("account_age_score")
  disputeRateScore       Int      @map("dispute_rate_score")
  breakdown              Json
  explanation            Json
  createdAt              DateTime @default(now()) @map("created_at")

  @@index([retailerId, createdAt(sort: Desc)])
  @@index([score])
  @@index([createdAt(sort: Desc)])
  @@map("credit_score_history")
}

model RiskConfig {
  id          String   @id @default(uuid())
  configKey   String   @unique @map("config_key")
  configValue Json     @map("config_value")
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  updatedBy   String?  @map("updated_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("risk_config")
}

model RiskAlert {
  id             String    @id @default(uuid())
  alertType      String    @map("alert_type")
  severity       String
  retailerId     String?   @map("retailer_id")
  vendorId       String?   @map("vendor_id")
  orderId        String?   @map("order_id")
  title          String
  description    String
  metadata       Json?
  isAcknowledged Boolean   @default(false) @map("is_acknowledged")
  acknowledgedBy String?   @map("acknowledged_by")
  acknowledgedAt DateTime? @map("acknowledged_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([retailerId, createdAt(sort: Desc)])
  @@index([alertType, severity])
  @@index([isAcknowledged, createdAt(sort: Desc)])
  @@map("risk_alerts")
}

model RiskAction {
  id            String   @id @default(uuid())
  actionType    String   @map("action_type")
  retailerId    String?  @map("retailer_id")
  triggeredBy   String   @map("triggered_by")
  previousValue Json?    @map("previous_value")
  newValue      Json?    @map("new_value")
  reason        String
  isAutomatic   Boolean  @default(true) @map("is_automatic")
  executedBy    String?  @map("executed_by")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([retailerId, createdAt(sort: Desc)])
  @@index([actionType, createdAt(sort: Desc)])
  @@map("risk_actions")
}

model RetailerRiskScore {
  id                     String   @id @default(uuid())
  retailerId             String   @unique @map("retailer_id")
  riskScore              Decimal  @default(0) @map("risk_score") @db.Decimal(5, 2)
  riskLevel              String   @default("LOW") @map("risk_level")
  paymentDelayScore      Decimal  @default(0) @map("payment_delay_score") @db.Decimal(5, 2)
  creditUtilizationScore Decimal  @default(0) @map("credit_utilization_score") @db.Decimal(5, 2)
  orderPatternScore      Decimal  @default(0) @map("order_pattern_score") @db.Decimal(5, 2)
  overdueAmount          Decimal  @default(0) @map("overdue_amount") @db.Decimal(15, 2)
  daysOverdue            Int      @default(0) @map("days_overdue")
  consecutiveDelays      Int      @default(0) @map("consecutive_delays")
  unusualActivityCount   Int      @default(0) @map("unusual_activity_count")
  lastCalculatedAt       DateTime @default(now()) @map("last_calculated_at")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@index([riskLevel])
  @@index([riskScore(sort: Desc)])
  @@map("retailer_risk_scores")
}

model OrderRoutingConfig {
  id          String   @id @default(uuid())
  configKey   String   @unique @map("config_key")
  configValue Json     @map("config_value")
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  updatedBy   String?  @map("updated_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("order_routing_config")
}

model VendorRoutingScore {
  id                     String   @id @default(uuid())
  vendorId               String   @unique @map("vendor_id")
  availabilityScore      Decimal  @default(0) @map("availability_score") @db.Decimal(5, 2)
  proximityScore         Decimal  @default(0) @map("proximity_score") @db.Decimal(5, 2)
  workloadScore          Decimal  @default(0) @map("workload_score") @db.Decimal(5, 2)
  priceScore             Decimal  @default(0) @map("price_score") @db.Decimal(5, 2)
  reliabilityScore       Decimal  @default(0) @map("reliability_score") @db.Decimal(5, 2)
  overallScore           Decimal  @default(0) @map("overall_score") @db.Decimal(5, 2)
  activeOrdersCount      Int      @default(0) @map("active_orders_count")
  pendingOrdersCount     Int      @default(0) @map("pending_orders_count")
  averageFulfillmentTime Int      @default(0) @map("average_fulfillment_time")
  lastCalculatedAt       DateTime @default(now()) @map("last_calculated_at")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@index([vendorId])
  @@index([overallScore(sort: Desc)])
  @@map("vendor_routing_scores")
}

model OrderRoutingLog {
  id                 String    @id @default(uuid())
  orderId            String?   @map("order_id")
  retailerId         String?   @map("retailer_id")
  routingAttempt     Int       @default(1) @map("routing_attempt")
  vendorsEvaluated   Json?     @map("vendors_evaluated")
  selectedVendorId   String?   @map("selected_vendor_id")
  fallbackVendorId   String?   @map("fallback_vendor_id")
  routingReason      String    @map("routing_reason")
  routingCriteria    Json?     @map("routing_criteria")
  isManualOverride   Boolean   @default(false) @map("is_manual_override")
  overrideBy         String?   @map("override_by")
  overrideReason     String?   @map("override_reason")
  acceptanceDeadline DateTime? @map("acceptance_deadline")
  acceptedAt         DateTime? @map("accepted_at")
  rejectedAt         DateTime? @map("rejected_at")
  rejectionReason    String?   @map("rejection_reason")
  createdAt          DateTime  @default(now()) @map("created_at")

  @@index([orderId])
  @@index([selectedVendorId])
  @@index([createdAt(sort: Desc)])
  @@map("order_routing_logs")
}

model OrderBroadcastLog {
  id                 String    @id @default(uuid())
  orderId            String    @map("order_id")
  vendorId           String    @map("vendor_id")
  phoneNumber        String
  message            String
  sentAt             DateTime  @default(now()) @map("sent_at")
  status             String
  twilioMessageId    String?   @map("twilio_message_id")
  responseReceivedAt DateTime? @map("response_received_at")
  responseType       String?
  order              Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  vendor             Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([vendorId])
  @@index([sentAt])
  @@map("order_broadcast_logs")
}

model VendorOrderAcceptance {
  id                  String    @id @default(uuid())
  vendorId            String    @map("vendor_id")
  orderId             String    @map("order_id")
  routingLogId        String?   @map("routing_log_id")
  status              String
  notifiedAt          DateTime? @map("notified_at")
  responseDeadline    DateTime? @map("response_deadline")
  respondedAt         DateTime? @map("responded_at")
  responseTimeMinutes Int?      @map("response_time_minutes")
  rejectionReason     String?   @map("rejection_reason")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([vendorId, status])
  @@index([orderId])
  @@index([status, responseDeadline])
  @@map("vendor_order_acceptances")
}

model Invoice {
  id            String    @id @default(uuid())
  invoiceNumber String    @unique @map("invoice_number")
  orderId       String    @map("order_id")
  retailerId    String    @map("retailer_id")
  totalAmount   Decimal   @map("total_amount") @db.Decimal(15, 2)
  paidAmount    Decimal   @default(0) @map("paid_amount") @db.Decimal(15, 2)
  dueAmount     Decimal   @map("due_amount") @db.Decimal(15, 2)
  status        String    @default("DRAFT")
  issueDate     DateTime  @default(now()) @map("issue_date")
  dueDate       DateTime  @map("due_date")
  paidAt        DateTime? @map("paid_at")
  createdBy     String    @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  createdByUser User      @relation("InvoiceCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  retailer      Retailer  @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([retailerId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model VendorSettlement {
  id               String    @id @default(uuid())
  settlementNumber String    @unique @map("settlement_number")
  vendorId         String    @map("vendor_id")
  totalOrders      Int       @map("total_orders")
  totalAmount      Decimal   @map("total_amount") @db.Decimal(15, 2)
  commissionAmount Decimal   @map("commission_amount") @db.Decimal(15, 2)
  settledAmount    Decimal   @map("settled_amount") @db.Decimal(15, 2)
  status           String    @default("PENDING")
  settlementDate   DateTime? @map("settlement_date")
  notes            String?
  createdBy        String    @map("created_by")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  orderId          String?
  createdByUser    User      @relation("SettlementCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  Order            Order?    @relation(fields: [orderId], references: [id])
  vendor           Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([status])
  @@index([settlementDate])
  @@map("vendor_settlements")
}

model UploadedOrder {
  id            String              @id @default(uuid())
  retailerId    String?             @map("retailer_id")
  imageUrl      String              @map("image_url")
  imageKey      String              @map("image_key")
  status        UploadedOrderStatus @default(PROCESSING)
  extractedText String?             @map("extracted_text")
  parsedData    Json?               @map("parsed_data")
  orderId       String?             @map("order_id")
  errorMessage  String?             @map("error_message")
  processedAt   DateTime?           @map("processed_at")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")
  order         Order?              @relation(fields: [orderId], references: [id])
  retailer      Retailer?           @relation(fields: [retailerId], references: [id])

  @@index([retailerId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([orderId])
  @@map("uploaded_orders")
}

model RejectedOrder {
  id               String    @id @default(uuid())
  retailerId       String    @map("retailer_id")
  orderData        Json      @map("order_data")
  rejectionReason  String    @map("rejection_reason")
  rejectionMessage String    @map("rejection_message")
  requestedAmount  Decimal   @default(0) @map("requested_amount") @db.Decimal(15, 2)
  availableCredit  Decimal   @default(0) @map("available_credit") @db.Decimal(15, 2)
  shortfall        Decimal?  @map("shortfall") @db.Decimal(15, 2)
  metadata         Json?
  isReviewed       Boolean   @default(false) @map("is_reviewed")
  reviewedAt       DateTime? @map("reviewed_at")
  reviewedBy       String?   @map("reviewed_by")
  reviewNotes      String?   @map("review_notes")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  retailer         Retailer  @relation("RejectedOrders", fields: [retailerId], references: [id], onDelete: Cascade)

  @@index([retailerId, createdAt(sort: Desc)])
  @@index([rejectionReason])
  @@index([isReviewed, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([reviewedBy])
  @@map("rejected_orders")
}

model WhatsAppDeliveryFailure {
  id             String                 @id @default(uuid())
  phoneNumber    String                 @map("phone_number")
  message        String
  idempotencyKey String                 @map("idempotency_key")
  errorMessage   String?                @map("error_message")
  errorCode      String?                @map("error_code")
  attemptCount   Int                    @default(1) @map("attempt_count")
  status         WhatsAppDeliveryStatus @default(PENDING)
  metadata       Json?
  nextRetryAt    DateTime?              @map("next_retry_at")
  lastAttemptAt  DateTime?              @map("last_attempt_at")
  resolvedAt     DateTime?              @map("resolved_at")
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")

  @@index([phoneNumber])
  @@index([status, nextRetryAt])
  @@index([idempotencyKey])
  @@index([createdAt(sort: Desc)])
  @@index([status, nextRetryAt, attemptCount])
  @@map("whatsapp_delivery_failures")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model health_alert_thresholds {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  metric_name         String   @unique @db.VarChar(100)
  warning_threshold   Decimal? @db.Decimal(15, 2)
  critical_threshold  Decimal? @db.Decimal(15, 2)
  comparison_operator String   @default("gt") @db.VarChar(10)
  enabled             Boolean  @default(true)
  alert_message       String?
  created_at          DateTime @default(now()) @db.Timestamp(6)
  updated_at          DateTime @default(now()) @db.Timestamp(6)
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model health_alerts {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  metric_name     String    @db.VarChar(100)
  alert_level     String    @db.VarChar(20)
  metric_value    Decimal   @db.Decimal(15, 2)
  threshold_value Decimal   @db.Decimal(15, 2)
  alert_message   String
  alert_metadata  Json?     @default("{}")
  resolved        Boolean   @default(false)
  resolved_at     DateTime? @db.Timestamp(6)
  created_at      DateTime  @default(now()) @db.Timestamp(6)
  updated_at      DateTime  @default(now()) @db.Timestamp(6)

  @@index([alert_level, created_at(sort: Desc)], map: "idx_health_alerts_level")
  @@index([metric_name, created_at(sort: Desc)], map: "idx_health_alerts_metric")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model health_metrics {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  metric_name     String   @db.VarChar(100)
  metric_value    Decimal  @db.Decimal(15, 2)
  metric_unit     String?  @db.VarChar(50)
  metric_status   String   @default("normal") @db.VarChar(20)
  metric_metadata Json?    @default("{}")
  recorded_at     DateTime @default(now()) @db.Timestamp(6)
  hour_bucket     DateTime @db.Timestamp(6)
  created_at      DateTime @default(now()) @db.Timestamp(6)

  @@index([hour_bucket(sort: Desc)], map: "idx_health_metrics_hour_bucket")
  @@index([metric_name, recorded_at(sort: Desc)], map: "idx_health_metrics_name_time")
  @@index([metric_status, recorded_at(sort: Desc)], map: "idx_health_metrics_status")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model system_health_snapshots {
  id                        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  database_status           Boolean
  database_response_time_ms Int?
  redis_status              Boolean
  redis_response_time_ms    Int?
  queue_backlog_total       Int      @default(0)
  queue_backlog_details     Json?    @default("{}")
  webhook_avg_latency_ms    Decimal? @db.Decimal(10, 2)
  failed_orders_last_hour   Int      @default(0)
  ocr_failures_last_hour    Int      @default(0)
  overall_health_score      Int      @default(100)
  overall_status            String   @default("healthy") @db.VarChar(20)
  snapshot_timestamp        DateTime @default(now()) @db.Timestamp(6)
  created_at                DateTime @default(now()) @db.Timestamp(6)

  @@index([overall_status, snapshot_timestamp(sort: Desc)], map: "idx_system_health_snapshots_status")
  @@index([snapshot_timestamp(sort: Desc)], map: "idx_system_health_snapshots_time")
}

enum UserRole {
  ADMIN
  OPERATOR
  VENDOR
  RETAILER
}

enum OrderStatus {
  RECEIVED
  PARSED
  ROUTED
  SENT_TO_VENDOR
  PLACED
  PENDING
  ACCEPTED
  PACKING
  DISPATCHED
  OUT_FOR_DELIVERY
  DELIVERED
  COMPLETED
  CANCELLED
  FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  FAILED
}

enum TransactionType {
  ORDER_DEBIT
  ORDER_CREDIT
  PAYMENT_DEBIT
  PAYMENT_CREDIT
  REFUND_DEBIT
  REFUND_CREDIT
  ADJUSTMENT_DEBIT
  ADJUSTMENT_CREDIT
  INTEREST_DEBIT
  INTEREST_CREDIT
}

enum CreditStatus {
  ACTIVE
  BLOCKED
  REVIEW
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
  CHEQUE
  CREDIT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  APPROVE
  REJECT
  PAYMENT
  REFUND
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  BLOCKED
}

enum InventoryStatus {
  AVAILABLE
  OUT_OF_STOCK
  LOW_STOCK
  DISCONTINUED
}

enum UploadedOrderStatus {
  PROCESSING
  COMPLETED
  FAILED
  PENDING_REVIEW
}

enum WhatsAppDeliveryStatus {
  PENDING
  RESOLVED
  FAILED
}
